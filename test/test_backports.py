# Copyright (C) 2021 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

from os import path, remove

import distro
import pytest

from cve_bin_tool.backports import DEBIAN_DISTROS, BackportReport
from cve_bin_tool.backports.debian_backports import DEB_CVE_JSON_PATH
from cve_bin_tool.util import CVE, CVEData, ProductInfo


class TestBackportReport:
    MOCK_CVE_DATA = {
        ProductInfo(vendor="gnu", product="pspp", version="1.2.0"): CVEData(
            None,
            {
                "cves": [
                    CVE(
                        cve_number="CVE-2018-20230",
                        severity="HIGH",
                        description="An issue was discovered in PSPP 1.2.0. There is a heap-based buffer overflow at the function read_bytes_internal in utilities/pspp-dump-sav.c, which allows attackers to cause a denial of service (application crash) or possibly have unspecified other impact.",
                        comments="",
                        score=7.8,
                        cvss_version=3,
                        cvss_vector="CVSS:3.0/AV:L/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H",
                    ),
                    CVE(
                        cve_number="CVE-2019-9211",
                        severity="MEDIUM",
                        description="There is a reachable assertion abort in the function write_long_string_missing_values() in data/sys-file-writer.c in libdata.a in GNU PSPP 1.2.0 that will lead to denial of service.",
                        comments="",
                        score=6.5,
                        cvss_version=3,
                        cvss_vector="CVSS:3.0/AV:N/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H",
                    ),
                ],
                "paths": {
                    "test/condensed-downloads/pspp-1.2.0-lp151.2.1.x86_64.rpm.tar.gz contains /usr/bin/pspp",
                    "test/condensed-downloads/pspp-1.2.0-lp151.2.1.x86_64.rpm.tar.gz contains /usr/lib64/pspp/libpspp-1.2.0.so",
                    "test/condensed-downloads/pspp-1.2.0-lp151.2.1.x86_64.rpm.tar.gz contains /usr/bin/psppire",
                },
            },
        )
    }

    @pytest.mark.skipif(
        distro.id() not in DEBIAN_DISTROS,
        reason="Runs only on Debian based distros",
    )
    def test_debian_backport_fix_output(self, caplog):
        """Test Backported fix for Debian distros output on console"""
        if path.exists(DEB_CVE_JSON_PATH):
            remove(DEB_CVE_JSON_PATH)
        backport = BackportReport(self.MOCK_CVE_DATA)
        backport.check_backport()
        expected_output = [
            "Updating Debian CVE JSON file for checking backported fixes.",
            "Debian CVE JSON file for checking backported fixes is updated.",
            "pspp: CVE-2018-20230 has backported fix in v1.2.0-3 release.",
            "pspp: CVE-2019-9211 has backported fix in v1.2.0-4 release.",
        ]

        assert expected_output == [rec.message for rec in caplog.records]
