# Copyright (C) 2022 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import shutil
import tempfile
from pathlib import Path

import pytest

from cve_bin_tool.data_sources import rsd_source


class TestSourceRSD:
    @classmethod
    def setup_class(cls):
        cls.rsd = rsd_source.RSD_Source()
        cls.rsd.cachedir = tempfile.mkdtemp(prefix="cvedb-")
        cls.rsd.rsd_path = str(Path(cls.rsd.cachedir) / "rsd")

    @classmethod
    def teardown_class(cls):
        shutil.rmtree(cls.rsd.cachedir)

    cve_file_data = {
        "CVE-2019-0200": {
            "affected_release": None,
            "package_state": [
                {
                    "product_name": "Red Hat Enterprise MRG 3",
                    "fix_state": "Affected",
                    "package_name": "qpid-java",
                    "cpe": "cpe:/a:redhat:enterprise_mrg:3",
                }
            ],
            "threat_severity": "Important",
            "public_date": "2019-03-01T00:00:00Z",
            "bugzilla": {
                "description": "CVE-2019-0200 qpid-java: Malformed AMQP 0-8 to 0-10 commands resulting in a Denial of Service",
                "id": "1685179",
                "url": "https://bugzilla.redhat.com/show_bug.cgi?id=1685179",
            },
            "cvss": {"cvss_base_score": "", "cvss_scoring_vector": "", "status": ""},
            "cvss3": {
                "cvss3_base_score": "7.5",
                "cvss3_scoring_vector": "CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
                "status": "draft",
            },
            "iava": "",
            "cwe": "CWE-20",
            "statement": "",
            "acknowledgement": "",
            "name": "CVE-2019-0200",
            "document_distribution": "",
            "details": [
                "A Denial of Service vulnerability was found in Apache Qpid Broker-J versions 6.0.0-7.0.6 (inclusive) and 7.1.0 which allows an unauthenticated attacker to crash the broker instance by sending specially crafted commands using AMQP protocol versions below 1.0 (AMQP 0-8, 0-9, 0-91 and 0-10). Users of Apache Qpid Broker-J versions 6.0.0-7.0.6 (inclusive) and 7.1.0 utilizing AMQP protocols 0-8, 0-9, 0-91, 0-10 must upgrade to Qpid Broker-J versions 7.0.7 or 7.1.1 or later."
            ],
            "references": None,
        },
        "CVE-2012-0444": {
            "affected_release": [
                {
                    "product_name": "Red Hat Enterprise Linux 4",
                    "release_date": "2012-02-01T00:00:00Z",
                    "advisory": "RHSA-2012:0079",
                    "package": "firefox-0:3.6.26-2.el4",
                    "cpe": "cpe:/o:redhat:enterprise_linux:4",
                },
                {
                    "product_name": "Red Hat Enterprise Linux 4",
                    "release_date": "2012-02-15T00:00:00Z",
                    "advisory": "RHSA-2012:0136",
                    "package": "libvorbis-1:1.1.0-4.el4.5",
                    "cpe": "cpe:/o:redhat:enterprise_linux:4",
                },
                {
                    "product_name": "Red Hat Enterprise Linux 5",
                    "release_date": "2012-02-01T00:00:00Z",
                    "advisory": "RHSA-2012:0079",
                    "package": "firefox-0:3.6.26-1.el5_7",
                    "cpe": "cpe:/o:redhat:enterprise_linux:5",
                },
                {
                    "product_name": "Red Hat Enterprise Linux 5",
                    "release_date": "2012-02-15T00:00:00Z",
                    "advisory": "RHSA-2012:0136",
                    "package": "libvorbis-1:1.1.2-3.el5_7.6",
                    "cpe": "cpe:/o:redhat:enterprise_linux:5",
                },
                {
                    "product_name": "Red Hat Enterprise Linux 6",
                    "release_date": "2012-02-01T00:00:00Z",
                    "advisory": "RHSA-2012:0079",
                    "package": "firefox-0:3.6.26-1.el6_2",
                    "cpe": "cpe:/o:redhat:enterprise_linux:6",
                },
                {
                    "product_name": "Red Hat Enterprise Linux 6",
                    "release_date": "2012-02-15T00:00:00Z",
                    "advisory": "RHSA-2012:0136",
                    "package": "libvorbis-1:1.2.3-4.el6_2.1",
                    "cpe": "cpe:/o:redhat:enterprise_linux:6",
                },
            ],
            "package_state": None,
            "threat_severity": "Critical",
            "public_date": "2012-01-31T00:00:00Z",
            "bugzilla": {
                "description": "CVE-2012-0444 Firefox: Ogg Vorbis Decoding Memory Corruption (MFSA 2012-07)",
                "id": "786026",
                "url": "https://bugzilla.redhat.com/show_bug.cgi?id=786026",
            },
            "cvss": {
                "cvss_base_score": "6.8",
                "cvss_scoring_vector": "AV:N/AC:M/Au:N/C:P/I:P/A:P",
                "status": "verified",
            },
            "cvss3": {"cvss3_base_score": "", "cvss3_scoring_vector": "", "status": ""},
            "iava": "",
            "cwe": "",
            "statement": "",
            "acknowledgement": "",
            "name": "CVE-2012-0444",
            "document_distribution": "",
            "details": [
                "Mozilla Firefox before 3.6.26 and 4.x through 9.0, Thunderbird before 3.1.18 and 5.0 through 9.0, and SeaMonkey before 2.7 do not properly initialize nsChildView data structures, which allows remote attackers to cause a denial of service (memory corruption and application crash) or possibly execute arbitrary code via a crafted Ogg Vorbis file."
            ],
            "references": [
                "http://www.mozilla.org/security/announce/2012/mfsa2012-07.html"
            ],
        },
    }

    severity_data = {
        "CVE-2019-0200": {
            "CVSS_vector": "unknown",
            "CVSS_version": "unknown",
            "ID": "CVE-2019-0200",
            "description": [
                "A Denial of Service vulnerability was found in Apache Qpid Broker-J versions 6.0.0-7.0.6 (inclusive) and 7.1.0 which allows an unauthenticated attacker to crash the broker instance by sending specially crafted commands using AMQP protocol versions below 1.0 (AMQP 0-8, 0-9, 0-91 and 0-10). Users of Apache Qpid Broker-J versions 6.0.0-7.0.6 (inclusive) and 7.1.0 utilizing AMQP protocols 0-8, 0-9, 0-91, 0-10 must upgrade to Qpid Broker-J versions 7.0.7 or 7.1.1 or later."
            ],
            "last_modified": "2019-03-01T00:00:00Z",
            "score": "unknown",
            "severity": "unknown",
        },
        "CVE-2012-0444": [],
    }

    affected_data = {
        "CVE-2019-0200": [
            {
                "cve_id": "CVE-2019-0200",
                "product": "enterprise_mrg",
                "vendor": "redhat",
                "version": "3",
                "versionEndExcluding": "",
                "versionEndIncluding": "",
                "versionStartExcluding": "",
                "versionStartIncluding": "",
            }
        ],
        "CVE-2012-0444": [],
    }

    @pytest.mark.parametrize("cve_entries", [[x] for _, x in cve_file_data.items()])
    def test_format_data(self, cve_entries):
        severity_data, affected_data = self.rsd.format_data(cve_entries)

        if len(severity_data) != 0:
            severity_data = severity_data[0]

        assert severity_data == self.severity_data[cve_entries[0]["name"]]
        assert affected_data == self.affected_data[cve_entries[0]["name"]]
