# Copyright (C) 2021 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import csv
import os
import re
import subprocess
from importlib.metadata import version

REQ_TXT = os.path.abspath(
    os.path.join(os.path.dirname(__file__), "..", "requirements.txt")
)
REQ_CSV = os.path.abspath(
    os.path.join(os.path.dirname(__file__), "..", "requirements.csv")
)
DOC_TXT = os.path.abspath(
    os.path.join(os.path.dirname(__file__), "..", "doc", "requirements.txt")
)
DOC_CSV = os.path.abspath(
    os.path.join(os.path.dirname(__file__), "..", "doc", "requirements.csv")
)

CACHE_PATH = os.path.join(os.path.expanduser("~"), ".cache", "cve-bin-tool")

CACHE_CSV = os.path.join(CACHE_PATH, "requirements.csv")

HTML_DEP_PATH = os.path.abspath(
    os.path.join(
        os.path.dirname(__file__),
        "..",
        "cve_bin_tool",
        "output_engine",
        "html_reports",
        "js",
    )
)
HTML_DEP_CSV = os.path.join(HTML_DEP_PATH, "dependencies.csv")

# Dependencies that currently have CVEs
# Remove from the list once they are updated
ALLOWED_PACKAGES = ["reportlab"]


def get_out_of_sync_packages(csv_name, txt_name):

    out_of_sync_txt_packages = set()
    out_of_sync_csv_packages = set()
    csv_package_names = set()
    txt_package_names = set()

    with open(csv_name) as csv_file, open(txt_name) as txt_file:
        csv_reader = csv.reader(csv_file)
        next(csv_reader)
        for (_, product) in csv_reader:
            csv_package_names.add(product)
        lines = txt_file.readlines()
        for line in lines:
            txt_package_names.add(re.split(">|\\[|;|=|\n", line)[0])
        out_of_sync_txt_packages = txt_package_names - csv_package_names
        out_of_sync_csv_packages = csv_package_names - txt_package_names

    return (out_of_sync_txt_packages, out_of_sync_csv_packages)


# Test to check if the requirements.csv files are in sync with requirements.txt files
def test_txt_csv_sync():

    errors = set()

    (
        out_of_sync_req_txt_packages,
        out_of_sync_req_csv_packages,
    ) = get_out_of_sync_packages(REQ_CSV, REQ_TXT)
    (
        out_of_sync_doc_txt_packages,
        out_of_sync_doc_csv_packages,
    ) = get_out_of_sync_packages(DOC_CSV, DOC_TXT)

    if out_of_sync_doc_csv_packages != set():
        errors.add(
            f"The requirements.txt and requirements.csv files of docs are out of sync! Please add {', '.join(out_of_sync_doc_csv_packages)} in the respective requirements.txt file\n"
        )
    if out_of_sync_doc_txt_packages != set():
        errors.add(
            f"The requirements.txt and requirements.csv files of docs are out of sync! Please add {', '.join(out_of_sync_doc_txt_packages)} in the respective requirements.csv file\n"
        )
    if out_of_sync_req_csv_packages != set():
        errors.add(
            f"The requirements.txt and requirements.csv files of cve-bin-tool are out of sync! Please add {', '.join(out_of_sync_req_csv_packages)} in the respective requirements.txt file\n"
        )
    if out_of_sync_req_txt_packages != set():
        errors.add(
            f"The requirements.txt and requirements.csv files of cve-bin-tool are out of sync! Please add {', '.join(out_of_sync_req_txt_packages)} in the respective requirements.csv file\n"
        )

    assert errors == set(), f"The errors are {''.join(errors)}"


def get_cache_csv_data(file):

    data = []

    with open(file) as f:
        r = csv.reader(f)
        next(r)
        for (vendor, product) in r:
            if file is HTML_DEP_CSV:
                file_name = f"{HTML_DEP_PATH}/{product}"
                if not file_name.endswith(".js"):
                    file_name += ".js"
                with open(file_name) as f:
                    file_content = f.read()
                    html_dep_version = re.search(
                        r"v([0-9]+\.[0-9]+\.[0-9]+)", file_content
                    ).group(1)
                    if product not in ALLOWED_PACKAGES:
                        data.append((vendor, product, html_dep_version))
            else:
                if "_not_in_db" not in vendor and product not in ALLOWED_PACKAGES:
                    data.append((vendor, product, version(product)))

        return data


# Test to check for CVEs in cve-bin-tool requirements/dependencies
def test_requirements():

    cache_csv_data = (
        get_cache_csv_data(REQ_CSV)
        + get_cache_csv_data(DOC_CSV)
        + get_cache_csv_data(HTML_DEP_CSV)
    )

    # writes a cache CSV file
    with open(CACHE_CSV, "w") as f:
        writer = csv.writer(f)
        fieldnames = ["vendor", "product", "version"]
        writer = csv.writer(f)
        writer.writerow(fieldnames)
        for row in cache_csv_data:
            writer.writerow(row)

    cve_check = subprocess.run(
        ["python", "-m", "cve_bin_tool.cli", "--input-file", CACHE_CSV]
    )
    assert (
        cve_check.returncode == 0
    ), f"{cve_check.returncode} dependencies/requirements have CVEs"
