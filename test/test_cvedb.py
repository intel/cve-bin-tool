# Copyright (C) 2022 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import datetime
import shutil
import tempfile
from test.utils import LONG_TESTS

import pytest

from cve_bin_tool import cvedb
from cve_bin_tool.data_sources import nvd_source


class TestCVEDB:
    @classmethod
    def setup_class(cls):
        cls.nvd = nvd_source.NVD_Source(nvd_type="json")
        cls.cvedb = cvedb.CVEDB(sources=[cls.nvd])
        cls.nvd.cachedir = tempfile.mkdtemp(prefix="cvedb-")

    @classmethod
    def teardown_class(cls):
        shutil.rmtree(cls.nvd.cachedir)

    @pytest.mark.asyncio
    @pytest.mark.skipif(
        LONG_TESTS() != 1, reason="Skipping NVD calls due to rate limits"
    )
    async def test_refresh_nvd_json(self):
        await self.cvedb.refresh()
        years = self.nvd.nvd_years()
        for year in range(2002, datetime.datetime.now().year):
            assert year in years, f"Missing NVD data for {year}"
