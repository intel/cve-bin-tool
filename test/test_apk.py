import json
import subprocess
from test.utils import APK_FILE_PATH

PRODUCTS = {"curl", "libcurl"}


def test_apk(tmpdir):
    # path to output in temporary directory
    json_output_path = tmpdir / "output.json"

    # scan apk file & generate output in json
    subprocess.run(
        [
            "python",
            "-m",
            "cve_bin_tool.cli",
            "--input-file",
            APK_FILE_PATH,
            "--format",
            "json",
            "--output-file",
            json_output_path,
        ]
    )

    # test.apk contains test-curl-7.34.0.out from assets
    # hence the output of cve-bin-tool should be the same for .apk and .out files.
    with open(json_output_path, encoding="utf-8") as content:
        json_file = json.load(content)

        assert len(json_file) >= 90

        for cve in json_file:
            assert cve.get("product", "") in PRODUCTS
