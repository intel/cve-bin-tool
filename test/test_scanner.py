# pylint: disable=too-many-public-methods, too-many-arguments, fixme
"""
CVE-bin-tool tests
"""
import itertools
import os
import shutil
import sys
import tempfile
import unittest
from collections import defaultdict

import pytest

from cve_bin_tool.cvedb import CVEDB
from cve_bin_tool.scanner import Scanner, InvalidFileError
from test.mapping_test_data import mapping_test_data
from test.utils import download_file, LONG_TESTS

BINARIES_PATH = os.path.join(os.path.abspath(os.path.dirname(__file__)), "binaries")


class TestScanner:
    """Runs a series of tests against our "faked" binaries.

    The faked binaries are very small c files containing the same string signatures we use
    in the cve-bin-tool.  They should trigger results as if they contained the library and
    version specified in the file name.

    At this time, the tests work only in python3.
    """

    @classmethod
    def setup_class(cls):
        cls.cvedb = CVEDB()
        if os.getenv("UPDATE_DB") == "1":
            cls.cvedb.get_cvelist_if_stale()
        else:
            print("Skip NVD database updates.")
        # Instantiate a scanner
        cls.scanner = Scanner(cls.cvedb)
        # temp dir for mapping tests
        cls.map_test_dir = tempfile.mkdtemp(prefix="mapping-test-")
        # temp dir for tests that require downloads
        cls.tempdir = tempfile.mkdtemp(prefix="cve-bin-tool-")

    @classmethod
    def teardown_class(cls):
        shutil.rmtree(cls.tempdir)
        shutil.rmtree(cls.map_test_dir)

    def setup_method(self):
        self.cvedb.open()

    def teardown_method(self):
        self.cvedb.close()

    def _mapping_test(self, module, version, version_strings):
        """ Helper function to scan a binary and check that it contains
        certain cves for a version and doesn't contain others."""

        # Run the scan
        self.scanner.all_cves = defaultdict(dict)
        version_strings = list(map(lambda s: f"{s}\n".encode("ascii"), version_strings))
        # first filename will test "is" and second will test "contains"
        filenames = [
            f"-{module}-{version}.out",
            f"{'.'.join(list(module))}-{version}.out",
        ]
        for filename in filenames:
            with tempfile.NamedTemporaryFile(
                "w+b", suffix=filename, dir=self.map_test_dir, delete=False
            ) as f:
                f.write(b"\x7f\x45\x4c\x46\x02\x01\x01\x03\n")
                f.writelines(version_strings)
                filename = f.name
            self.scanner.scan_file(os.path.join(self.map_test_dir, filename))
            # print(d)
            # Make sure the package and version are in the results
            assert module in self.scanner.all_cves
            assert version in self.scanner.all_cves[module]

    def _product_version_detection_test(self, url, filename, package, version):
        """ Helper function to get a file (presumed to be a real copy
        of a library, probably from a Linux distribution) and run a
        scan on it.  Any test using this should likely be listed as a
        long test."""
        # get file
        tempfile = os.path.join(self.tempdir, filename)
        download_file(url + filename, tempfile)
        # new scanner for the new test.
        self.scanner = Scanner(cvedb=self.cvedb, should_extract=True)
        # run the tests
        self.scanner.recursive_scan(tempfile)

        # make sure we found the expected package/version
        assert package in self.scanner.all_cves
        assert version in self.scanner.all_cves[package]

    def test_does_not_scan_symlinks(self):
        """ Test that the scanner doesn't scan symlinks """
        if sys.platform.startswith("linux"):
            # we can only do this in linux since symlink is privilege operation in windows
            os.symlink("non-existant-file", "non-existant-link")
            try:
                assert self.scanner.scan_file("non-existant-link") is None
            finally:
                os.unlink("non-existant-link")

    def test_cannot_open_file(self):
        """ Test behaviour when file cannot be opened """
        with pytest.raises(InvalidFileError):
            self.scanner.scan_file(os.path.join(self.map_test_dir, "non-existant-file"))

    @pytest.mark.parametrize(
        "module, version, version_strings",
        map(lambda d: d.values(), mapping_test_data),
    )
    def test_binaries(self, module, version, version_strings):
        self._mapping_test(module, version, version_strings)

    @pytest.mark.parametrize(
        "url, filename, package, version",
        list(
            itertools.chain(
                [
                    # Filetests for binutils checker
                    (
                        "http://security.ubuntu.com/ubuntu/pool/main/b/binutils/",
                        "binutils_2.26.1-1ubuntu1~16.04.8_amd64.deb",
                        "binutils",
                        "2.26.1",
                    ),
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "binutils-2.27-43.base.el7.x86_64.rpm",
                        "binutils",
                        "2.27",
                    ),
                ],
                [
                    # Filetests for busybox checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/busybox/1.28.2/1.fc29/x86_64/",
                        "busybox-1.28.2-1.fc29.x86_64.rpm",
                        "busybox",
                        "1.28.2",
                    ),
                    (
                        "http://archive.ubuntu.com/ubuntu/pool/universe/b/busybox/",
                        "busybox_1.18.5-1ubuntu4_amd64.deb",
                        "busybox",
                        "1.18.5",
                    ),
                ],
                [
                    # Filetests for bzip2 checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/bzip2/1.0.4/10.fc7/x86_64/",
                        "bzip2-1.0.4-10.fc7.x86_64.rpm",
                        "bzip2",
                        "1.0.4",
                    ),
                    (
                        "http://mirror.centos.org/centos/6/os/x86_64/Packages/",
                        "bzip2-1.0.5-7.el6_0.x86_64.rpm",
                        "bzip2",
                        "1.0.5",
                    ),
                ],
                [
                    # Filetests for cups checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/cups/1.3.3/1.fc8/x86_64/",
                        "cups-1.3.3-1.fc8.x86_64.rpm",
                        "cups",
                        "1.3.3",
                    ),
                ],
                [
                    # Filetests for curl checker
                    (
                        "https://archives.fedoraproject.org/pub/archive/fedora/linux"
                        "/releases/20/Everything/x86_64/os/Packages/c/",
                        "curl-7.32.0-3.fc20.x86_64.rpm",
                        "curl",
                        "7.32.0",
                    ),
                    (
                        "https://rpmfind.net/linux/openmandriva/4.0/repository"
                        "/aarch64/main/release/",
                        "curl-7.65.0-2-omv4000.aarch64.rpm",
                        "curl",
                        "7.65.0",
                    ),
                ],
                [
                    # Filetests for dovecot checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/dovecot/2.2.10/1.fc20/x86_64/",
                        "dovecot-2.2.10-1.fc20.x86_64.rpm",
                        "dovecot",
                        "2.2.10",
                    ),
                    (
                        "http://rpmfind.net/linux/mageia/distrib/5/x86_64/media/core/updates/",
                        "dovecot-2.2.13-5.1.mga5.x86_64.rpm",
                        "dovecot",
                        "2.2.13",
                    ),
                ],
                [
                    # Filetests for expat checker
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "expat-2.1.0-11.el7.x86_64.rpm",
                        "expat",
                        "2.1.0",
                    ),
                    (
                        "https://kojipkgs.fedoraproject.org/packages/expat/2.2.1/1.fc24/x86_64/",
                        "expat-2.2.1-1.fc24.x86_64.rpm",
                        "expat",
                        "2.2.1",
                    ),
                    (
                        "http://http.us.debian.org/debian/pool/main/e/expat/",
                        "libexpat1_2.2.0-2+deb9u3_amd64.deb",
                        "expat",
                        "2.2.0",
                    ),
                ],
                [
                    # Filetests for ffmpeg checker
                    (
                        "http://archive.ubuntu.com/ubuntu/pool/universe/f/ffmpeg/",
                        "ffmpeg_4.1.4-1build2_amd64.deb",
                        "ffmpeg",
                        "4.1.4",
                    ),
                ],
                [
                    # Filetests for gnutls checker
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "gnutls-utils-3.3.29-9.el7_6.x86_64.rpm",
                        "gnutls-cli",
                        "3.3.29",
                    ),
                    (
                        "http://archive.ubuntu.com/ubuntu/pool/universe/g/gnutls28/",
                        "gnutls-bin_3.4.10-4ubuntu1.7_amd64.deb",
                        "gnutls-cli",
                        "3.4.10",
                    ),
                ],
                [
                    # Filetests for gstreamer checker
                    (
                        "http://archive.ubuntu.com/ubuntu/pool/universe/g/gstreamermm-1.0/",
                        "libgstreamermm-1.0-0v5_1.4.3+dfsg-5_amd64.deb",
                        "gstreamer",
                        "1.0",
                    ),
                    (
                        "http://mirror.centos.org/centos/6/os/x86_64/Packages/",
                        "gstreamer-0.10.29-1.el6.x86_64.rpm",
                        "gstreamer",
                        "0.10",
                    ),
                ],
                [
                    # Filetests for hostapd checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/hostapd/2.3/1.fc20/x86_64/",
                        "hostapd-2.3-1.fc20.x86_64.rpm",
                        "hostapd",
                        "2.3",
                    ),
                    (
                        "http://security.ubuntu.com/ubuntu/pool/universe/w/wpa/",
                        "hostapd_2.1-0ubuntu1.7_amd64.deb",
                        "hostapd",
                        "2.1",
                    ),
                ],
                [
                    # Filetests for icu checker
                    (
                        "https://rpmfind.net/linux/centos/6.10/os/i386/Packages/",
                        "icu-4.2.1-14.el6.i686.rpm",
                        "international_components_for_unicode",
                        "4.2.1",
                    ),
                ],
                [
                    # Filetests for kerberos checker
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "krb5-libs-1.15.1-46.el7.x86_64.rpm",
                        "kerberos_5",
                        "1.15.1",
                    ),
                ],
                [
                    # Filetests for libdb checker
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "libdb-5.3.21-25.el7.i686.rpm",
                        "libdb",
                        "11.2.5.3.21",
                        # Note that the full libdb version is longer than the package version
                    ),
                ],
                [
                    # Filetests for libgcrypt checker
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "libgcrypt-1.5.3-14.el7.x86_64.rpm",
                        "libgcrypt",
                        "1.5.3",
                    ),
                    (
                        "http://rpmfind.net/linux/fedora/linux/releases/30/Everything/x86_64/os/Packages/l/",
                        "libgcrypt-1.8.4-3.fc30.x86_64.rpm",
                        "libgcrypt",
                        "1.8.4",
                    ),
                ],
                [
                    # Filetests for libjpeg checker
                    (
                        "http://rpmfind.net/linux/fedora/linux/releases/30/Everything/x86_64/os/Packages/l/",
                        "libjpeg-turbo-2.0.2-1.fc30.x86_64.rpm",
                        "libjpeg-turbo",
                        "2.0.2",
                    ),
                ],
                [
                    # Filetests for libnss checker
                    (
                        "http://rpmfind.net/linux/openmandriva/3.0/repository/x86_64/main/updates/",
                        "nss-3.42.1-1-omv2015.0.x86_64.rpm",
                        "nss",
                        "3.42.1",
                    ),
                    (
                        "https://kojipkgs.fedoraproject.org/packages/nss/3.37.3/3.fc29/x86_64/",
                        "nss-3.37.3-3.fc29.x86_64.rpm",
                        "nss",
                        "3.37.3",
                    ),
                ],
                [
                    # Filetests for libtiff checker
                    (
                        "http://rpmfind.net/linux/fedora/linux/releases/30/Everything/x86_64/os/Packages/l/",
                        "libtiff-4.0.10-4.fc30.i686.rpm",
                        "tiff",
                        "4.0.10",
                    ),
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "libtiff-4.0.3-32.el7.x86_64.rpm",
                        "tiff",
                        "4.0.3",
                    ),
                ],
                [
                    # Filetests for lighttpd checker
                    (
                        "https://mirrors.kernel.org/fedora/releases/31/Everything/x86_64/os/Packages/l/",
                        "lighttpd-1.4.54-2.fc31.x86_64.rpm",
                        "lighttpd",
                        "1.4.54",
                    ),
                    (
                        "https://ftp.lysator.liu.se/pub/opensuse/distribution/leap/15.1/repo/oss/x86_64/",
                        "lighttpd-1.4.49-lp151.2.3.x86_64.rpm",
                        "lighttpd",
                        "1.4.49",
                    ),
                ],
                [
                    # Filetests for ncurses checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/ncurses/6.2/1.20200222.fc33/x86_64/",
                        "ncurses-6.2-1.20200222.fc33.x86_64.rpm",
                        "ncurses",
                        "6.2",
                    ),
                    (
                        "https://mirrors.edge.kernel.org/centos/7/os/x86_64/Packages/",
                        "ncurses-libs-5.9-14.20130511.el7_4.x86_64.rpm",
                        "ncurses",
                        "5.9",
                    ),
                ],
                [
                    # Filetests for nessus checker
                    (
                        "https://download-ib01.fedoraproject.org/pub/fedora/linux/releases/30/Everything/aarch64/os/Packages/n/",
                        "nessus-libraries-2.2.11-16.fc29.aarch64.rpm",
                        "nessus",
                        "2.2.11",
                    ),
                ],
                [
                    # Filetests for nginx checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/nginx/1.8.0/10.fc22/x86_64/",
                        "nginx-1.8.0-10.fc22.x86_64.rpm",
                        "nginx",
                        "1.8.0",
                    ),
                ],
                [
                    # Filetests for node checker
                    (
                        "https://nodejs.org/dist/v12.16.1/",
                        "node-v12.16.1-linux-x64.tar.xz",
                        "node",
                        "12.16.1",
                    ),
                ],
                [
                    # Filetests for openafs checker
                    (
                        "http://rpmfind.net/linux/mageia/distrib/5/x86_64/media/core/updates/",
                        "openafs-client-1.6.13-1.mga5.x86_64.rpm",
                        "openafs",
                        "1.6.13",
                    ),
                    (
                        "http://archive.ubuntu.com/ubuntu/pool/universe/o/openafs/",
                        "openafs-client_1.6.15-1ubuntu1_amd64.deb",
                        "openafs",
                        "1.6.15",
                    ),
                ],
                [
                    # Filetests for openssh checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/openssh/6.8p1/1.1.fc23/x86_64/",
                        "openssh-clients-6.8p1-1.1.fc23.x86_64.rpm",
                        "openssh-client",
                        "6.8p1",
                    ),
                ],
                [
                    # Filetests for openssl checker
                    (
                        "http://rpmfind.net/linux/mageia/distrib/5/i586/media/core/updates/",
                        "openssl-1.0.2g-1.1.mga5.i586.rpm",
                        "openssl",
                        "1.0.2g",
                    ),
                ],
                [
                    # Filetests for openswan checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/openswan/2.6.31/1.fc14/x86_64/",
                        "openswan-2.6.31-1.fc14.x86_64.rpm",
                        "openswan",
                        "2.6.31",
                    ),
                    (
                        "http://mirror.centos.org/centos/6/os/x86_64/Packages/",
                        "openswan-2.6.32-37.el6.x86_64.rpm",
                        "openswan",
                        "2.6.32",
                    ),
                ],
                [
                    # Filetests for openvpn checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/openvpn/2.4.1/1.fc25/x86_64/",
                        "openvpn-2.4.1-1.fc25.x86_64.rpm",
                        "openvpn",
                        "2.4.1",
                    ),
                    (
                        "http://rpmfind.net/linux/mageia/distrib/5/x86_64/media/core/updates/",
                        "openvpn-2.3.12-1.mga5.x86_64.rpm",
                        "openvpn",
                        "2.3.12",
                    ),
                ],
                [
                    # Filetests for png checker
                    (
                        "http://rpmfind.net/linux/fedora/linux/releases/30/Everything/x86_64/os/Packages/l/",
                        "libpng-1.6.36-1.fc30.x86_64.rpm",
                        "png",
                        "1.6.36",
                    ),
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "libpng-1.5.13-7.el7_2.x86_64.rpm",
                        "png",
                        "1.5.13",
                    ),
                ],
                [
                    # Filetests for polarssl checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/polarssl/1.3.7/2.fc21/x86_64/",
                        "polarssl-1.3.7-2.fc21.x86_64.rpm",
                        "polarssl",
                        "1.3.7",
                    ),
                ],
                [
                    # Filetests for postgresql checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/postgresql/9.4.4/1.fc22/x86_64/",
                        "postgresql-9.4.4-1.fc22.x86_64.rpm",
                        "postgresql",
                        "9.4.4",
                    ),
                ],
                [
                    # Filetests for python checker
                    (
                        "https://kojipkgs.fedoraproject.org//packages/python3/3.8.2~rc1/1.fc33/aarch64/",
                        "python3-3.8.2~rc1-1.fc33.aarch64.rpm",
                        "python",
                        "3.8.2",
                    ),
                    (
                        "https://rpmfind.net/linux/openmandriva/4.0/repository/x86_64/main/release/",
                        "python-3.7.3-4-omv4000.x86_64.rpm",
                        "python",
                        "3.7.3",
                    ),
                ],
                [
                    # Filetests for radare2 checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/radare2/3.0.1/2.fc27/x86_64/",
                        "radare2-3.0.1-2.fc27.x86_64.rpm",
                        "radare2",
                        "3.0.1",
                    ),
                    (
                        "http://archive.ubuntu.com/ubuntu/pool/universe/r/radare2/",
                        "radare2_3.2.1+dfsg-5build1_amd64.deb",
                        "radare2",
                        "3.2.1",
                    ),
                ],
                [
                    # Filetests for rsyslog checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/rsyslog/5.5.7/1.fc15/x86_64/",
                        "rsyslog-5.5.7-1.fc15.x86_64.rpm",
                        "rsyslog",
                        "5.5.7",
                    ),
                ],
                [
                    # Filetests for sqlite checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/sqlite/3.16.2/1.fc26/x86_64/",
                        "sqlite-3.16.2-1.fc26.x86_64.rpm",
                        "sqlite",
                        "3.16.2",
                    ),
                    (
                        "http://rpmfind.net/linux/atrpms/el4-x86_64/atrpms/stable/",
                        "sqlite-3.1.2-2.99_2.el4.at.i386.rpm",
                        "sqlite",
                        "3.1.2",
                    ),
                ],
                [
                    # Filetests for strongswan checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/strongswan/4.6.2/1.fc16/x86_64/",
                        "strongswan-4.6.2-1.fc16.x86_64.rpm",
                        "strongswan",
                        "4.6.2",
                    ),
                ],
                [
                    # Filetests for syslogng checker
                    (
                        "https://mirrors.kernel.org/fedora-buffet/archive/fedora/linux/releases/21/Everything/x86_64/os/Packages/s/",
                        "syslog-ng-3.5.6-3.fc21.x86_64.rpm",
                        "syslog-ng",
                        "3.5.6",
                    ),
                ],
                [
                    # Filetests for systemd checker
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "systemd-219-73.el7.1.x86_64.rpm",
                        "systemd",
                        "219",
                    ),
                    (
                        "http://security.ubuntu.com/ubuntu/pool/main/s/systemd/",
                        "systemd_229-4ubuntu21.27_amd64.deb",
                        "systemd",
                        "229",
                    ),
                    (
                        "https://rpmfind.net/linux/openmandriva/4.0/repository/x86_64/main/release/",
                        "systemd-242.20190509-1-omv4000.x86_64.rpm",
                        "systemd",
                        "242",
                    ),
                    (
                        "https://rpmfind.net/linux/fedora/linux/releases/31/Everything/x86_64/os/Packages/s/",
                        "systemd-243-4.gitef67743.fc31.i686.rpm",
                        "systemd",
                        "243",
                    ),
                ],
                [
                    # Filetests for varnish checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/varnish/4.0.5/1.el7/x86_64/",
                        "varnish-4.0.5-1.el7.x86_64.rpm",
                        "varnish",
                        "4.0.5",
                    ),
                ],
                [
                    # Filetests for wireshark checker
                    (
                        "https://kojipkgs.fedoraproject.org/packages/wireshark/1.10.13/1.fc20/x86_64/",
                        "wireshark-1.10.13-1.fc20.x86_64.rpm",
                        "wireshark",
                        "1.10.13",
                    ),
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "wireshark-1.10.14-24.el7.x86_64.rpm",
                        "wireshark",
                        "1.10.14",
                    ),
                ],
                [
                    # Filetests for xerces checker
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "xerces-c-3.1.1-9.el7.x86_64.rpm",
                        "xerces",
                        "3.1",  # FIXME: This is a bug in our detection on Centos
                    ),
                ],
                [
                    # Filetests for xml2 checker
                    (
                        "http://rpmfind.net/linux/fedora/linux/releases/30/Everything/x86_64/os/Packages/l/",
                        "libxml2-2.9.9-2.fc30.x86_64.rpm",
                        "xml2",
                        "2.9.9",
                    ),
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "libxml2-2.9.1-6.el7.4.x86_64.rpm",
                        "xml2",
                        "2.9.1",
                    ),
                ],
                [
                    # Filetests for zlib checker
                    (
                        "http://rpmfind.net/linux/fedora/linux/updates/testing/31/Everything/aarch64/Packages/z/",
                        "zlib-1.2.11-19.fc31.aarch64.rpm",
                        "zlib",
                        "1.2.11",
                    ),
                    (
                        "http://mirror.centos.org/centos/7/os/x86_64/Packages/",
                        "zlib-1.2.7-18.el7.x86_64.rpm",
                        "zlib",
                        "1.2.7",
                    ),
                    (
                        "http://archive.ubuntu.com/ubuntu/pool/main/z/zlib/",
                        "zlib1g_1.2.8.dfsg-2ubuntu4_amd64.deb",
                        "zlib",
                        "1.2.8",
                    ),
                ],
                list(
                    map(
                        lambda item: (
                            "http://xmlsoft.org/sources/",
                            item[0],
                            "xml2",
                            item[1],
                        ),
                        [
                            ["libxml2-2.7.2-1.x86_64.rpm", "2.7.2"],
                            ["libxml2-2.7.3-1.x86_64.rpm", "2.7.3"],
                            ["libxml2-2.7.4-1.x86_64.rpm", "2.7.4"],
                            ["libxml2-2.7.5-1.x86_64.rpm", "2.7.5"],
                            ["libxml2-2.7.6-1.x86_64.rpm", "2.7.6"],
                            ["libxml2-2.7.7-1.x86_64.rpm", "2.7.7"],
                            ["libxml2-2.7.8-1.x86_64.rpm", "2.7.8"],
                            ["libxml2-2.8.0-1.x86_64.rpm", "2.8.0"],
                            ["libxml2-2.9.0-0rc0.x86_64.rpm", "2.9.0"],
                            ["libxml2-2.9.0-0rc1.x86_64.rpm", "2.9.0"],
                            ["libxml2-2.9.0-0rc2.x86_64.rpm", "2.9.0"],
                            ["libxml2-2.9.0-1.x86_64.rpm", "2.9.0"],
                            ["libxml2-2.9.1-1.fc17.x86_64.rpm", "2.9.1"],
                            ["libxml2-2.9.2-0rc1.fc19.x86_64.rpm", "2.9.2"],
                            ["libxml2-2.9.2-0rc2.fc19.x86_64.rpm", "2.9.2"],
                            ["libxml2-2.9.2-1.fc19.x86_64.rpm", "2.9.2"],
                            ["libxml2-2.9.3-1.fc23.x86_64.rpm", "2.9.3"],
                            ["libxml2-2.9.4-0rc1.fc23.x86_64.rpm", "2.9.4"],
                            ["libxml2-2.9.4-0rc2.fc23.x86_64.rpm", "2.9.4"],
                            ["libxml2-2.9.4-1.fc23.x86_64.rpm", "2.9.4"],
                            ["libxml2-2.9.5-0rc1.fc24.x86_64.rpm", "2.9.5"],
                            ["libxml2-2.9.5-0rc2.fc24.x86_64.rpm", "2.9.5"],
                            ["libxml2-2.9.5-1.fc24.x86_64.rpm", "2.9.5"],
                            ["libxml2-2.9.6-0rc1.fc26.x86_64.rpm", "2.9.6"],
                            ["libxml2-2.9.6-1.fc26.x86_64.rpm", "2.9.6"],
                            ["libxml2-2.9.7-0rc1.fc26.x86_64.rpm", "2.9.7"],
                            ["libxml2-2.9.7-1.fc26.x86_64.rpm", "2.9.7"],
                            ["libxml2-2.9.8-0rc1.fc26.x86_64.rpm", "2.9.8"],
                            ["libxml2-2.9.8-1.fc26.x86_64.rpm", "2.9.8"],
                            ["libxml2-2.9.9-0rc1.fc28.x86_64.rpm", "2.9.9"],
                            ["libxml2-2.9.9-0rc2.fc28.x86_64.rpm", "2.9.9"],
                            ["libxml2-2.9.9-1.fc28.x86_64.rpm", "2.9.9"],
                        ],
                    )
                ),
            )
        ),
    )
    @unittest.skipUnless(LONG_TESTS() > 0, "Skipping long tests")
    def test_files(self, url, filename, package, version):
        self._product_version_detection_test(url, filename, package, version)
