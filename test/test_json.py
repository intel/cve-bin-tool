#!/usr/bin/python
""" Validates the NIST data feed
1. Against their schema.
This uses the schemas mentioned here: https://nvd.nist.gov/vuln/Data-Feeds/JSON-feed-changelog
2. Against the provided metadata, including the sha256sum
"""
import hashlib
import json
import os
import unittest
import datetime
from zipfile import ZipFile
from jsonschema import validate
from jsonschema.exceptions import ValidationError

try:
    from urllib2 import urlopen
except ImportError:
    from urllib.request import urlopen

NVD_SCHEMA = "https://scap.nist.gov/schema/nvd/feed/1.1/nvd_cve_feed_json_1.1.schema"


# NVD feeds from "https://nvd.nist.gov/vuln/data-feeds#JSON_FEED" but stored locally
DISK_LOCATION_DEFAULT = os.path.join(os.path.expanduser("~"), ".cache", "cvedb")
NVD_FILE_TEMPLATE = "nvdcve-1.1-{}.json"


class TestJSON(unittest.TestCase):
    def test_json_validation(self):
        """ Validate latest nvd json file against their published schema """
        # Download the schema
        schema = json.loads(urlopen(NVD_SCHEMA).read().decode("utf-8"))
        print("Loaded schema")

        # NVD database started in 2002, so range then to now.
        years = list(range(2002, datetime.datetime.now().year + 1))
        # Open the latest nvd file on disk
        for year in years:
            with open(
                os.path.join(DISK_LOCATION_DEFAULT, NVD_FILE_TEMPLATE.format(year)),
                "rb",
            ) as json_file:
                nvd_json = json.loads(json_file.read())
                print(
                    "Loaded json for year {}: {}".format(
                        year, NVD_FILE_TEMPLATE.format(year)
                    )
                )

                # Validate -- will raise a ValidationError if not valid
                try:
                    validate(nvd_json, schema)
                    print("Validation complete")
                except ValidationError as ve:
                    print(ve)
                    self.fail("Validation error occured")
