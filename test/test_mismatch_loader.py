import os
import sqlite3
import tempfile

from cve_bin_tool.mismatch_loader import setup_sqlite


def test_mismatch_loader():
    with tempfile.NamedTemporaryFile(suffix=".db") as temp_db:

        parent_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        data_dir = os.path.join(parent_dir, "data")

        setup_sqlite(data_dir, temp_db.name)

        # Connect to the database and check if zstandard is present
        conn = sqlite3.connect(temp_db.name)
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM mismatch;")
        result = cursor.fetchall()
        conn.close()

        expected = (
            "pkg:pypi/zstandard",
            "facebook",
        )
        assert expected in result
