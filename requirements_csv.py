# Copyright (C) 2021 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

# Script to add versions to requirements.csv

import csv
import os
import pkg_resources

REQ_CSV = os.path.abspath(os.path.join(os.path.dirname(__file__), "requirements.csv"))
DOC_CSV = os.path.abspath(
    os.path.join(os.path.dirname(__file__), "doc", "requirements.csv")
)
CACHE_CSV = os.path.join(
    os.path.expanduser("~"), ".cache", "cve-bin-tool", "requirements.csv"
)


def get_cache_csv_data(file):
    data = []
    with open(file, "r") as f:
        r = csv.reader(f)
        next(r)
        for row in r:
            if "_not_in_db" not in row[0]:
                data.append(
                    (row[0], row[1], pkg_resources.get_distribution(row[1]).version)
                )
        return data


cache_csv_data = get_cache_csv_data(REQ_CSV) + get_cache_csv_data(DOC_CSV)

# writes a cache CSV file
with open(CACHE_CSV, "w") as f:
    writer = csv.writer(f)
    fieldnames = ["vendor", "product", "version"]
    writer = csv.writer(f)
    writer.writerow(fieldnames)
    for row in cache_csv_data:
        writer.writerow(row)
