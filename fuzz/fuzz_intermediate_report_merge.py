# Copyright (C) 2022 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import sys
import tempfile
from pathlib import Path

import atheris
import atheris_libprotobuf_mutator
from google.protobuf.json_format import MessageToJson

import fuzz.protobuff.intermediate_report_pb2 as intermediate_report_pb2

with atheris.instrument_imports():
    from cve_bin_tool.merge import MergeReports


def TestParseData(data):
    try:
        json_data = MessageToJson(data)
        with open(file_path, "w") as f:
            f.write(json_data)

        intermediate_report = MergeReports(merge_files=[file_path])
        intermediate_report.merge_intermediate()

    except SystemExit:
        return


file_path = str(
    Path(tempfile.mkdtemp(prefix="cve-bin-tool-")) / "test_intermediate.json"
)
atheris_libprotobuf_mutator.Setup(
    sys.argv, TestParseData, proto=intermediate_report_pb2.IntermediateReport
)
atheris.Fuzz()
