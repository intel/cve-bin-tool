#!/usr/bin/python3

"""
CVE checker for binutils

References:
https://www.gnu.org/software/binutils/
https://www.cvedetails.com/vulnerability-list/vendor_id-72/product_id-6825/GNU-Binutils.html
"""
import re

def guess_version(lines):
    """ Guesses the binutils version from the file contents """
    new_guess = ""
    pattern1 = re.compile(r"\(GNU Binutils[^)]*\) ([0-9]+\.[0-9]+\.[0-9]+)")
    # ubuntu changed the version line, so the * is to catch their "for ubuntu" or other
    # distros that may have done the same

    for line in lines:
        match = pattern1.search(line)
        if match:
            new_guess2 = match.group(1).strip()
            if len(new_guess2) > len(new_guess):
                new_guess = new_guess2
    print("version: " + new_guess)
    return new_guess

def guess_contains(lines):
    """
    Tries to determine if a file includes binutils.
    Since binutils is actually collection of different utils we'll try to include strings
    for all of them.
    """
    signatures = [
        r"\(GNU Binutils\) ",
        r"\(GNU Binutils for Ubuntu\) ",
        # bfd
        r"Auxiliary filter for shared object symbol table",
        # strings
        r"can't set BFD default target to `%s': %s",
    ]

    for line in lines:
        for signature in signatures:
            pattern = re.compile(signature)
            if pattern.search(line):
                return 1
    return 0

def get_version(lines, filename):
    """returns version information for binutiles as found in a given file.

    VPkg: gnu, binutils
    """
    version_info = dict()

    util_names = [
        # command line utils
        "ld.bfd",
        "strings",
        # library
        "libbfd-", # FIXME: maybe should be patterns?
    ]
    for name in util_names:
        if name in filename:
            version_info["is_or_contains"] = "is"
    if not "is_or_contains" in version_info:
        # then guess
        if guess_contains(lines):
            version_info["is_or_contains"] = "contains"

    if "is_or_contains" in version_info:
        version_info["modulename"] = "binutils"
        version_info["version"] = guess_version(lines)

    print("binutils checker")
    return version_info
