# !/usr/bin/env python3
"""
CVE checker for HarfBuzz

References:
https://www.cvedetails.com/vulnerability-list/vendor_id-9481/Gstreamer.html

Library: re
"""
import re


def guess_contains(lines):
    """Tries to determine if a file includes harfbuzz
    """
    count = 0
    should_contain = [
        # Following lines are common in harfbuzz bin
        "Linked HarfBuzz library has a different version: %s",
        "Comma-separated list of font features",
        "Set font functions implementation to use (default: %s)",
        # Following lines are common in libharfbuzz
        "%%%%%%%%%%",
        "&&&&&",
        "*****",
        "77777777777777777777777777",
    ]
    for line in lines:
        for i in should_contain:
            if i in line:
                count += 1
    return True if count >= (len(should_contain) // 2) else False


def guess_version(lines):
    version_string = r"((\d+\.)+\d+)"
    for i in range(len(lines)):
        version = re.search(version_string, lines[i])
        if version:
            check_valid = ["HarfBuzz", "hb-common.cc"]
            for check in check_valid:
                if check in lines[i + 1]:
                    return version.group(1).strip()


def get_version(lines, filename):
    """returns version information for harfbuzz as found in a given file.
    VPkg: harfbuzz_project, harfbuzz
    """
    version_info = dict()
    if "harfbuzz" in filename:
        version_info["is_or_contains"] = "is"

    elif guess_contains(lines):
        version_info["is_or_contains"] = "contains"

    if "is_or_contains" in version_info:
        version_info["modulename"] = "harfbuzz"
        version_info["version"] = guess_version(lines)

    return version_info
