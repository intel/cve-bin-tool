import pkg_resources

from .log import LOGGER


class OutputEngine(object):
    def __init__(self, modules=None, logger=None):
        if logger is None:
            logger = LOGGER.getChild(self.__class__.__name__)
        self.modules = modules
        self.logger = logger
        self.outputs = {}
        self.plugins = self.load_output_plugins()

    def add_output(self, filename, out_format):
        self.outputs[out_format] = filename

    @staticmethod
    def load_output_plugins():
        return dict(
            map(
                lambda plugin: (plugin.name, plugin.load()),
                pkg_resources.iter_entry_points("cve_bin_tool.outputs"),
            )
        )

    def generate_outputs(self):
        for k, v in self.outputs.items():
            self.plugins[k](v, self.modules, self.logger).create_output()
