# Copyright (C) 2021 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import csv
import json
import re
import subprocess
from collections import defaultdict
from logging import Logger
from os.path import dirname, isfile, join

from cve_bin_tool.error_handler import (
    EmptyTxtError,
    ErrorHandler,
    ErrorMode,
    NotTxtError,
)
from cve_bin_tool.log import LOGGER
from cve_bin_tool.util import ProductInfo, Remarks

ROOT_PATH = join(dirname(__file__), "..")
PYPI_CSV = join(ROOT_PATH, "package_list_parser", "pypi_list.csv")


class PackageListParser:
    def __init__(
        self, input_file: str, logger: Logger = None, error_mode=ErrorMode.TruncTrace
    ) -> None:
        self.input_file = input_file
        self.logger = logger or LOGGER.getChild(self.__class__.__name__)
        self.error_mode = error_mode
        self.parsed_data = defaultdict(dict)

    def parse_list(self):
        input_file = self.input_file

        if not isfile(input_file):
            with ErrorHandler(mode=self.error_mode):
                raise FileNotFoundError(self.input_file)

        if not input_file.endswith(".txt"):
            with ErrorHandler(mode=self.error_mode):
                raise NotTxtError(self.input_file)

        txt_package_names = set()
        csv_package_names = set()
        package_names_w_vendor = []
        installed_packages_json = subprocess.run(
            ["pip", "list", "--format", "json"],
            stdout=subprocess.PIPE,
        )
        installed_packages = json.loads(
            str(installed_packages_json.stdout)[2:-1].split("\\n")[0]
        )

        with open(PYPI_CSV) as csvfile, open(input_file) as txtfile:
            csv_reader = csv.reader(csvfile)
            next(csv_reader)
            lines = txtfile.readlines()
            if lines == []:
                with ErrorHandler(mode=self.error_mode):
                    raise EmptyTxtError(self.input_file)
            for line in lines:
                txt_package_names.add(re.split(">|\\[|;|=|\n", line)[0])
            for (vendor, product) in csv_reader:
                csv_package_names.add(product)
                for installed_package in installed_packages:
                    package_name = installed_package["name"].lower()
                    if (
                        package_name in txt_package_names
                        and installed_package["name"].lower() == product
                    ):
                        installed_package["vendor"] = vendor
                        package_names_w_vendor.append(installed_package)

            not_found_package_names = txt_package_names - csv_package_names
            LOGGER.warning(
                f"{not_found_package_names} are not found in the mapping. Please provide them if possible."
            )
            self.parse_data(package_names_w_vendor)
            return self.parsed_data

    def parse_data(self, data):
        for row in data:
            product_info = ProductInfo(
                row["vendor"], row["name"].lower(), row["version"]
            )
            self.parsed_data[product_info][
                row.get("cve_number", "").strip() or "default"
            ] = {
                "remarks": Remarks(str(row.get("remarks", "")).strip()),
                "comments": row.get("comments", "").strip(),
                "severity": row.get("severity", "").strip(),
            }
            self.parsed_data[product_info]["paths"] = {""}
