# Copyright (C) 2022 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

import re

from cve_bin_tool.parsers import Parser


class GoParser(Parser):
    """
    Parser implementation for Go module files (go.mod).

    This parser is designed to parse Go module files and generate Package URL (PURL) strings
    based on the modules and their dependencies listed in the file.

    Attributes:
        cve_db (CVEDB): The CVE database instance used for vulnerability information.
        logger (Logger): The logger instance for logging messages and debugging information.

    Methods:
        generate_purl(product, version, vendor):
            Generate a PURL string based on the provided product, version, and vendor information.
        is_valid_data(product, version, vendor):
            Returns true if all the components of the PURL are valid.
        run_checker(filename):
            Parse the Go module file and yield valid PURLs for the modules listed in the file.

    """

    def __init__(self, cve_db, logger):
        super().__init__(cve_db, logger)

    def is_valid_data(self, product, version, vendor):
        """Returns true if all the components of the PURL are valid."""

        if any(arg is None for arg in (product, version, vendor)):
            return False

        if vendor == "UNKNOWN":
            self.logger.debug("Unknown vendor")
            return False

        if not re.match(r"^[a-zA-Z0-9\-_]+$", product):
            self.logger.debug(
                f"Product {product}: didn't match Golang's naming specification"
            )
            return False

        if not re.match(r"^[a-zA-Z_][a-zA-Z0-9\-_]+$", vendor):
            self.logger.debug(
                f"Vendor {vendor}: didn't match Golang's naming specification"
            )
            return False

        if not re.match(r"^[a-zA-Z0-9][a-zA-Z0-9\-.]+$", version):
            self.logger.debug(
                f"Version {version}: didn't match Golang's versioning specification"
            )
            return False

        return True

    def run_checker(self, filename):
        """Parse the file and yield valid PURLs."""
        self.filename = filename
        with open(self.filename) as fh:
            lines = fh.readlines()
            packages = False
            for line in lines:
                # A go.mod file has requirements that look like this:
                # require (
                #     github.com/davecgh/go-spew v1.1.1
                #     github.com/evanphx/json-patch v4.12.0+incompatible
                # )
                line = line.strip()
                if line == "require (":
                    packages = True
                    continue
                if line == ")":
                    packages = False
                    continue
                if packages:
                    parts = line.split(" ")
                    if len(parts) >= 2:
                        product = line.split(" ")[0].split("/")[-1]
                        version = line.split(" ")[1][1:].split("-")[0].split("+")[0]
                        vendors = self.find_vendor(product, version)
                        if vendors is not None:
                            for v in vendors:
                                if self.is_valid_data(
                                    product, version, v.product_info.vendor
                                ):
                                    self.generate_purl(
                                        product,
                                        version,
                                        v.product_info.vendor,
                                        "golang",
                                        {},
                                        None,
                                    )
                                    yield from vendors
            self.logger.debug(f"Done scanning file: {self.filename}")
