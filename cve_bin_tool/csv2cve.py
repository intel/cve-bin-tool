#!/usr/bin/python3
from __future__ import print_function

import argparse
import csv
import sys

from collections import defaultdict
from .cvedb import CVEDB
from .log import LOGGER
from .OutputEngine import OutputEngine

ERR_BADCSV = -1
ERR_MISSINGCOLUMN = -2


def main(argv=None, outfile=None):
    """ Take a list of product information + versions from a CSV file,
    and output a list of matching CVES """

    if argv is None:
        argv = sys.argv

    if outfile is None:
        outfile = sys.stdout

    parser = argparse.ArgumentParser(
        prog="csv2cve",
        description="This tool takes a list of software + versions from a CSV file and outputs a list of CVEs known to affect those versions",
    )
    parser.add_argument(
        "csv_file",
        action="store",
        help="CSV file with product data. Must contain vendor,product,version, where vendor and product match entries in the National Vulnerability Database.",
    )

    if len(argv) <= 1:
        parser.print_help()
        return 0

    args = parser.parse_args(argv[1:])

    csv2cve(args.csv_file)


def csv2cve(filename):
    # Parse the csv file
    LOGGER.debug(f"opening file: {filename}")

    with open(filename) as csvfile:
        csvdata = csv.DictReader(csvfile, delimiter=",")  # "," is default anyhow

        if csvdata is None or csvdata.fieldnames is None:
            LOGGER.error("Error: invalid CSV")
            return ERR_BADCSV

        required_columns = {"vendor", "product", "version"}
        csv_columns = set(csvdata.fieldnames)
        missing_columns = required_columns - csv_columns
        if missing_columns != set():
            LOGGER.error(f"Error: no {missing_columns} columns found")
            return ERR_MISSINGCOLUMN

        # Initialize the NVD database
        cvedb = CVEDB()
        cvedb.get_cvelist_if_stale()

        all_cves = defaultdict(dict)
        
        # Go row by row and look for CVEs
        for row in csvdata:
            cves = cvedb.get_cves(row["vendor"], row["product"], row["version"])
            
            if cves:
                LOGGER.debug(
                    f'Found CVES for {row["vendor"]} {row["product"]}, version {row["version"]}'
                )
                # if we found CVES add to the all_cves in sorted order
                all_cves[row["product"]][row["version"]] = cves
            
            else:
                
                LOGGER.debug(f'No CVEs found for {row["vendor"]} {row["product"]}, version {row["version"]}. Is the vendor/product info correct?')
                # Vendor Product is wrong mark CVE_Number and Severity  = UNKNOWN 
                all_cves[row["product"]][row["version"]] = {"UNKOWN":"UNKOWN"}

        # close down the NVD database
        cvedb.close()

        # Initialize OutputEngine
        output_engine = OutputEngine(modules=all_cves)
        
        # Call for ConsoleOutput
        output_engine.output_cves(sys.stdout)

        return all_cves


if __name__ == "__main__":
    sys.exit(main())
