# Copyright (C) 2021 Intel Corporation
# SPDX-License-Identifier: GPL-3.0-or-later

from typing import Dict

import distro

from cve_bin_tool.cve_scanner import CVEData
from cve_bin_tool.log import LOGGER
from cve_bin_tool.output_engine.util import ProductInfo

from .debian_backports import UBUNTU_DEBIAN_MAP, DebianCVETracker

DEBIAN_DISTROS = ["debian", "ubuntu"]


class BackportReport:
    def __init__(self, all_cve_data: Dict[ProductInfo, CVEData], distro_info):
        self.all_cve_data = all_cve_data
        self.distro_info = distro_info

    def check_backport(self):
        if self.distro_info != "local":
            distro_name, distro_codename = self.distro_info.split("-")
        else:
            distro_name = distro.id()
            distro_codename = distro.codename()

        if distro_name in DEBIAN_DISTROS:
            debian_tracker = DebianCVETracker(distro_name, distro_codename)
            debian_tracker.cve_info(self.all_cve_data)
        else:
            LOGGER.info(
                f"CVE Binary Tool doesn't support Backport Fix Utility for {distro_name.capitalize()} at the moment."
            )


def get_backport_supported_distros():
    """Generates a list for --backports-fix option in distro-distro_codename fashion"""

    supported_distros = []
    for distro_name in DEBIAN_DISTROS:
        if distro_name == "ubuntu":
            supported_distros += [
                f"{distro_name}-{distro_codename}"
                for distro_codename in UBUNTU_DEBIAN_MAP.keys()
            ]
        else:
            supported_distros += [
                f"{distro_name}-{distro_codename}"
                for distro_codename in set(UBUNTU_DEBIAN_MAP.values())
            ]
    supported_distros.append("local")
    return supported_distros
