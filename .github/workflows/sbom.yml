name: SBOM generation

on:
  schedule:
    # Runs at 02:00 UTC every Monday
    - cron: '2 0 * * 1'

jobs:
  sbom_gen:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: '**/requirements.txt'
      - name: Get date
        id: get-date
        run: |
          echo "date=$(/bin/date -u "+%Y%m%d")" >> $GITHUB_OUTPUT
      - name: Get cached database
        uses: actions/cache@v3
        with:
          path: ~/.cache/cve-bin-tool
          key: ${{ runner.os }}-cve-bin-tool-${{ steps.get-date.outputs.date }}
      - name: Install dependencies and cve-bin-tool
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          python -m pip install --upgrade wheel
          python -m pip install --upgrade pytest
          python -m pip install --upgrade sbom4python
          pip install . -r doc/requirements.txt
      - name: Generate SBOM for cve-bin-tool
        run: |
          sbom4python --module cve-bin-tool --output sbom/cve-bin-tool.spdx
          sbom4python --module cve-bin-tool --sbom cyclonedx --format json --output sbom/cve-bin-tool.json
#      - name: Compare SBOM for cve-bin-tool
#        # This would fail due to time/date of SBOM generation in SBOM header
#        # Therefore ignore first 10 lines of file in comparison which is SBOM header
#        run: |
#          /bin/tail -n +10 sbom/cve-bin-tool.spdx > orig
#          /bin/tail -n +10 cve-bin-tool.spdx > new
#          /bin/diff -b orig new
#      - name: Display generated SBOM if difference detected
#        if: ${{ failure() }}
#        run: |
#          /bin/cat cve-bin-tool.spdx

